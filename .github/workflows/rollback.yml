name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      rollback-to:
        description: 'Image tag or version to rollback to (leave empty for previous version)'
        required: false
        type: string

jobs:
  # =====================================================
  # Validate Rollback Request
  # =====================================================
  validate:
    name: Validate Rollback
    runs-on: ubuntu-latest
    outputs:
      can-rollback: ${{ steps.check.outputs.can-rollback }}
    steps:
      - name: Validate environment
        id: check
        run: |
          echo "Environment: ${{ inputs.environment }}"
          echo "Rollback to: ${{ inputs.rollback-to }}"
          echo "can-rollback=true" >> $GITHUB_OUTPUT

      - name: Require manual approval for production
        if: inputs.environment == 'production'
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: ${{ secrets.PROD_APPROVERS }}
          minimum-approvals: 2
          issue-title: "üî¥ PRODUCTION ROLLBACK APPROVAL REQUIRED"
          issue-body: |
            **CRITICAL: Production Rollback Request**
            
            Environment: ${{ inputs.environment }}
            Rollback to: ${{ inputs.rollback-to || 'Previous Version' }}
            Requested by: ${{ github.actor }}
            
            **Please review and approve this rollback carefully.**

  # =====================================================
  # Rollback Development
  # =====================================================
  rollback-dev:
    name: Rollback Development
    runs-on: ubuntu-latest
    needs: validate
    if: inputs.environment == 'development'
    environment:
      name: development
    steps:
      - name: Rollback Development Swarm
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SWARM_HOST }}
          username: ${{ secrets.DEV_SWARM_USER }}
          key: ${{ secrets.DEV_SWARM_SSH_KEY }}
          script: |
            cd /opt/servermonitoring
            
            if [ -n "${{ inputs.rollback-to }}" ]; then
              # Rollback to specific version
              echo "Rolling back to specific version: ${{ inputs.rollback-to }}"
              docker service update --image ghcr.io/${{ github.repository }}/api:${{ inputs.rollback-to }} servermonitoring_api
              docker service update --image ghcr.io/${{ github.repository }}/web:${{ inputs.rollback-to }} servermonitoring_web
            else
              # Rollback to previous version (Docker Swarm automatic rollback)
              echo "Rolling back to previous version..."
              docker service rollback servermonitoring_api
              docker service rollback servermonitoring_web
            fi
            
            # Verify rollback
            sleep 30
            docker service ps servermonitoring_api --no-trunc
            docker service ps servermonitoring_web --no-trunc

      - name: Health Check
        run: |
          sleep 30
          curl -f https://dev.servermonitoring.com/health || exit 1

  # =====================================================
  # Rollback Staging
  # =====================================================
  rollback-staging:
    name: Rollback Staging
    runs-on: ubuntu-latest
    needs: validate
    if: inputs.environment == 'staging'
    environment:
      name: staging
    steps:
      - name: Rollback Staging Swarm
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_SWARM_HOST }}
          username: ${{ secrets.STAGING_SWARM_USER }}
          key: ${{ secrets.STAGING_SWARM_SSH_KEY }}
          script: |
            cd /opt/servermonitoring
            
            if [ -n "${{ inputs.rollback-to }}" ]; then
              echo "Rolling back to specific version: ${{ inputs.rollback-to }}"
              docker service update --image ghcr.io/${{ github.repository }}/api:${{ inputs.rollback-to }} servermonitoring_api
              docker service update --image ghcr.io/${{ github.repository }}/web:${{ inputs.rollback-to }} servermonitoring_web
            else
              echo "Rolling back to previous version..."
              docker service rollback servermonitoring_api
              docker service rollback servermonitoring_web
            fi
            
            sleep 30
            docker service ps servermonitoring_api --no-trunc
            docker service ps servermonitoring_web --no-trunc

      - name: Health Check
        run: |
          sleep 30
          curl -f https://staging.servermonitoring.com/health || exit 1

  # =====================================================
  # Rollback Production (Requires Approval)
  # =====================================================
  rollback-production:
    name: Rollback Production
    runs-on: ubuntu-latest
    needs: validate
    if: inputs.environment == 'production'
    environment:
      name: production
    steps:
      - name: Create Incident Report
        run: |
          echo "Creating incident report..."
          echo "Rollback initiated at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "Initiated by: ${{ github.actor }}"
          echo "Rollback to: ${{ inputs.rollback-to || 'Previous Version' }}"

      - name: Notify Team
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: 'üî¥ PRODUCTION ROLLBACK IN PROGRESS',
              attachments: [{
                color: 'danger',
                text: `Rollback initiated by ${process.env.AS_AUTHOR}\nEnvironment: Production\nTarget: ${{ inputs.rollback-to || 'Previous Version' }}`
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

      - name: Rollback Production Swarm
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SWARM_HOST }}
          username: ${{ secrets.PROD_SWARM_USER }}
          key: ${{ secrets.PROD_SWARM_SSH_KEY }}
          script: |
            cd /opt/servermonitoring
            
            # Create rollback snapshot
            echo "Creating rollback snapshot..."
            mkdir -p /opt/backups/rollback-$(date +%Y%m%d-%H%M%S)
            docker service inspect servermonitoring_api > /opt/backups/rollback-$(date +%Y%m%d-%H%M%S)/api-before.json
            docker service inspect servermonitoring_web > /opt/backups/rollback-$(date +%Y%m%d-%H%M%S)/web-before.json
            
            if [ -n "${{ inputs.rollback-to }}" ]; then
              echo "Rolling back to specific version: ${{ inputs.rollback-to }}"
              docker service update \
                --update-parallelism 2 \
                --update-delay 5s \
                --image ghcr.io/${{ github.repository }}/api:${{ inputs.rollback-to }} \
                servermonitoring_api
              
              docker service update \
                --update-parallelism 2 \
                --update-delay 5s \
                --image ghcr.io/${{ github.repository }}/web:${{ inputs.rollback-to }} \
                servermonitoring_web
            else
              echo "Rolling back to previous version..."
              docker service rollback --detach=false servermonitoring_api
              docker service rollback --detach=false servermonitoring_web
            fi
            
            echo "Waiting for services to stabilize..."
            sleep 60
            
            # Verify services are running
            docker service ls
            docker service ps servermonitoring_api --no-trunc
            docker service ps servermonitoring_web --no-trunc

      - name: Comprehensive Health Check
        run: |
          echo "Running health checks..."
          
          # Wait for services to be ready
          sleep 60
          
          # Check multiple times to ensure stability
          for i in {1..10}; do
            echo "Health check attempt $i..."
            
            if curl -f https://servermonitoring.com/health && \
               curl -f https://servermonitoring.com/api/health/ready && \
               curl -f https://servermonitoring.com/api/health/live; then
              echo "Health check $i passed"
            else
              echo "Health check $i failed"
              exit 1
            fi
            
            sleep 10
          done
          
          echo "All health checks passed successfully!"

      - name: Run Smoke Tests
        run: |
          # Test critical endpoints
          curl -f https://servermonitoring.com/api/health
          curl -f https://servermonitoring.com/
          echo "Smoke tests passed"

      - name: Notify Success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: '‚úÖ PRODUCTION ROLLBACK COMPLETED SUCCESSFULLY',
              attachments: [{
                color: 'good',
                text: `Production has been successfully rolled back.\nRolled back to: ${{ inputs.rollback-to || 'Previous Version' }}\nAll health checks passed.`
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

      - name: Notify Failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: '‚ùå PRODUCTION ROLLBACK FAILED',
              attachments: [{
                color: 'danger',
                text: `CRITICAL: Production rollback failed!\nImmediate investigation required.\nRollback target: ${{ inputs.rollback-to || 'Previous Version' }}`
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # =====================================================
  # Post-Rollback Verification
  # =====================================================
  verify:
    name: Post-Rollback Verification
    runs-on: ubuntu-latest
    needs: [rollback-dev, rollback-staging, rollback-production]
    if: always()
    steps:
      - name: Generate Rollback Report
        run: |
          cat << EOF > rollback-report.md
          # Rollback Report
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Environment:** ${{ inputs.environment }}
          **Initiated By:** ${{ github.actor }}
          **Rollback Target:** ${{ inputs.rollback-to || 'Previous Version' }}
          **Status:** ${{ needs.rollback-production.result || needs.rollback-staging.result || needs.rollback-dev.result }}
          
          ## Details
          - Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - Commit: ${{ github.sha }}
          
          ## Next Steps
          1. Verify application functionality
          2. Review logs for any issues
          3. Investigate root cause of issues requiring rollback
          4. Plan remediation before next deployment
          EOF
          
          cat rollback-report.md

      - name: Upload Rollback Report
        uses: actions/upload-artifact@v4
        with:
          name: rollback-report-${{ inputs.environment }}-${{ github.run_id }}
          path: rollback-report.md
