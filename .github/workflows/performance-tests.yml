name: Performance Tests

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        type: choice
        options:
          - staging
          - production
      duration:
        description: 'Test duration in minutes'
        required: true
        default: '10'

jobs:
  load-test:
    name: Load Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Create k6 test script
        run: |
          cat << 'EOF' > load-test.js
          import http from 'k6/http';
          import { check, sleep } from 'k6';
          
          export let options = {
            stages: [
              { duration: '2m', target: 100 },  // Ramp up to 100 users
              { duration: '${{ inputs.duration }}m', target: 100 },  // Stay at 100 users
              { duration: '2m', target: 200 },  // Ramp up to 200 users
              { duration: '2m', target: 0 },    // Ramp down
            ],
            thresholds: {
              'http_req_duration': ['p(95)<500', 'p(99)<1000'],  // 95% < 500ms, 99% < 1s
              'http_req_failed': ['rate<0.01'],  // Error rate < 1%
            },
          };
          
          const BASE_URL = __ENV.BASE_URL || 'https://staging.servermonitoring.com';
          
          export default function () {
            // Test health endpoint
            let healthRes = http.get(`${BASE_URL}/health`);
            check(healthRes, {
              'health status is 200': (r) => r.status === 200,
              'health response time < 200ms': (r) => r.timings.duration < 200,
            });
            
            sleep(1);
            
            // Test API endpoints
            let apiRes = http.get(`${BASE_URL}/api/servers`);
            check(apiRes, {
              'api status is 200 or 401': (r) => r.status === 200 || r.status === 401,
              'api response time < 500ms': (r) => r.timings.duration < 500,
            });
            
            sleep(2);
          }
          EOF

      - name: Run load test
        env:
          BASE_URL: ${{ inputs.environment == 'production' && 'https://servermonitoring.com' || 'https://staging.servermonitoring.com' }}
        run: |
          k6 run --out json=results.json load-test.js

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: results.json

      - name: Notify on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: '⚠️ Performance test failed',
              attachments: [{
                color: 'warning',
                text: 'Load testing thresholds not met on ${{ inputs.environment }}'
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
